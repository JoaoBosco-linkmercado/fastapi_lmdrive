<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <link href="{{ url_for('static', path='favicon.png') }}" rel="shortcut icon"/>
    <link href="{{ url_for('static', path='css/style.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', path='css/hover-min.css') }}" rel="stylesheet"/>
    <!-- 
    <link href="{{ url_for('static', path='css/bootstrap.min.css') }}" rel="stylesheet"/>
     -->
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- font-awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <title>Link Drive</title>
  </head>
<body>
  <header class="bg-primary text-white text-center p-3">
    <div class="d-flex justify-content-between align-items-center" style="gap: 10px">
      <h1 class="text-center flex-grow-1">{{header}}</h1>
              {% if gera_external_link == 'Y' %}
              <a class="btn btn-info" data-bs-toggle="tooltip" href="/external_use/" title="gerar link cliente" type="sumbit"><i class="fa fa-key"></i></a>
              {% endif %}
              <a class="btn btn-warning" data-bs-toggle="tooltip" href="/logout/" title="sair" type="sumbit"><i class="fa fa-door-open"></i></a>
    </div>
  </header>

  {% block content %} 
  {% endblock %}

  
<script>
/* =========================================================
   OVERRIDES / EXTENSIONS (mantém funções antigas no arquivo)
   - DOCX/XLSX vindo como JSON array (mesma forma)
   - handleDoubleClick impede download no dblclick e abre modal
   - stopPreviewMedia/closeModal param audio/video de verdade
   - confirmação de apagar com ampulheta/spinner
   - troca de nome via AJAX (OK/NOK) com spinner/mensagem
========================================================= */

/* ---- helper: baixar binário mesmo quando servidor devolve JSON array ---- */
async function fetchBytesAsArrayBuffer(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error("Falha ao baixar arquivo");

  const ct = (r.headers.get("content-type") || "").toLowerCase();
  if (!ct.includes("application/json")) {
    return await r.arrayBuffer();
  }

  const json = await r.json();
  const arr = Array.isArray(json) ? json : (json.data || json.bytes || json.content || json.file);
  if (!Array.isArray(arr)) throw new Error("JSON não contém array de bytes");

  return new Uint8Array(arr).buffer;
}

/* ---- mídia: parar SEMPRE quando fechar ---- */
function stopPreviewMedia() {
  const modal = document.getElementById("showfileModal");
  if (!modal) return;

  modal.querySelectorAll("video, audio").forEach((m) => {
    try {
      m.pause();
      m.removeAttribute("src");
      m.querySelectorAll("source").forEach(s => s.removeAttribute("src"));
      m.load();
    } catch (e) {
      console.warn("Falha ao parar mídia:", e);
    }
  });
}

function closeModal() {
  const office = document.getElementById("showfileOffice");
  stopPreviewMedia();
  try { if (typeof hideLoading === "function") hideLoading(); } catch(e) {}
  if (office?.dataset?.pptxBlobUrl) {
    URL.revokeObjectURL(office.dataset.pptxBlobUrl);
    delete office.dataset.pptxBlobUrl;
  }
  const modal = document.getElementById("showfileModal");
  if (modal) modal.style.display = "none";
}


/* ---- loading preview: usa #previewLoading se existir ---- */
function _previewShowLoading() {
  const l = document.getElementById("previewLoading");
  if (l) l.classList.remove("d-none");
}

function _previewHideLoading() {
  const l = document.getElementById("previewLoading");
  if (l) l.classList.add("d-none");
}

/* ---- handleDoubleClick (override) ---- */
function handleDoubleClick_1(event, mediatype) {
  // evita navegação/download do <a> no dblclick
  if (event) {
    event.preventDefault?.();
    event.stopPropagation?.();
    event.stopImmediatePropagation?.();
  }

  const obj =
    event?.target?.getAttribute?.("obj") ||
    event?.target?.closest?.("[obj]")?.getAttribute?.("obj");

  if (!obj) return false;

  const url = "/browse/" + obj;
  const ext = (obj.split(".").pop() || "").toLowerCase();

  const modal = document.getElementById("showfileModal");
  const label = document.getElementById("pdfModalLabel");

  const img = document.getElementById("showfileImage");
  const pdf = document.getElementById("showfilePdf");
  const vid = document.getElementById("showfileVideo");
  const aud = document.getElementById("showfileAudio");
  const txt = document.getElementById("showfileText");
  const office = document.getElementById("showfileOffice");

  function hideAll() {
    // esconde viewers se existirem
    [img, pdf, vid, aud, txt, office].forEach(el => el?.classList?.add("d-none"));
    _previewHideLoading();

    if (img) img.src = "";
    if (pdf) pdf.src = "";

    if (vid) { try { vid.pause(); } catch(e){} vid.removeAttribute("src"); vid.load(); }
    if (aud) { try { aud.pause(); } catch(e){} aud.removeAttribute("src"); aud.load(); }

    if (txt) txt.textContent = "";
    if (office) office.innerHTML = "";
  }

  function openModal(title) {
    if (label) label.textContent = title;
    if (modal) modal.style.display = "block";
  }

  hideAll();

  // Imagem
  if (mediatype === "image") {
    openModal("Imagem");
    _previewShowLoading();
    if (img) {
      img.onload = img.onerror = () => _previewHideLoading();
      img.src = url;
      img.classList.remove("d-none");
    } else {
      _previewHideLoading();
      window.open(url, "_blank");
    }
    return false;
  }

  // PDF
  if (mediatype === "pdf") {
    openModal("PDF");
    _previewShowLoading();
    if (pdf) {
      pdf.onload = pdf.onerror = () => _previewHideLoading();
      pdf.src = url;
      pdf.classList.remove("d-none");
    } else {
      _previewHideLoading();
      window.open(url, "_blank");
    }
    return false;
  }

  // Vídeo
  if (mediatype === "video") {
    openModal("Vídeo");
    _previewShowLoading();
    if (vid) {
      vid.onloadedmetadata = () => _previewHideLoading();
      vid.oncanplaythrough = () => _previewHideLoading();
      vid.onerror = () => _previewHideLoading();
      vid.onwaiting = () => _previewShowLoading();
      vid.onplaying = () => _previewHideLoading();
      vid.src = url;
      vid.classList.remove("d-none");
      vid.load();
    } else {
      _previewHideLoading();
      window.open(url, "_blank");
    }
    return false;
  }

  // Áudio
  if (mediatype === "audio") {
    openModal("Áudio");
    _previewShowLoading();
    if (aud) {
      aud.onloadedmetadata = () => _previewHideLoading();
      aud.oncanplaythrough = () => _previewHideLoading();
      aud.onerror = () => _previewHideLoading();
      aud.onwaiting = () => _previewShowLoading();
      aud.onplaying = () => _previewHideLoading();
      aud.src = url;
      aud.classList.remove("d-none");
      aud.load();
    } else {
      _previewHideLoading();
      window.open(url, "_blank");
    }
    return false;
  }

  // Texto
  if (mediatype === "text") {
    openModal("Texto");
    _previewShowLoading();
    if (txt) {
      fetch(url)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(content => {
          txt.textContent = content;
          txt.classList.remove("d-none");
          _previewHideLoading();
        })
        .catch(() => {
          txt.textContent = "Erro ao carregar arquivo.";
          txt.classList.remove("d-none");
          _previewHideLoading();
        });
    } else {
      _previewHideLoading();
      window.open(url, "_blank");
    }
    return false;
  }

  // DOCX
  if (mediatype === "doc") {
    openModal("Documento");
    _previewShowLoading();
    if (!office || !window.docx) {
      _previewHideLoading();
      window.open(url, "_blank");
      return false;
    }
    office.classList.remove("d-none");
    fetchBytesAsArrayBuffer(url)
      .then(buf => window.docx.renderAsync(buf, office))
      .then(() => _previewHideLoading())
      .catch((e) => {
        console.error(e);
        office.innerHTML = "Não foi possível renderizar o DOCX.";
        _previewHideLoading();
      });
    return false;
  }

  // XLSX/XLS/ODS
  if  (mediatype === "excel") {
    openModal("Planilha");
    _previewShowLoading();
    if (!office || !window.XLSX) {
      _previewHideLoading();
      window.open(url, "_blank");
      return false;
    }
    office.classList.remove("d-none");
    fetchBytesAsArrayBuffer(url)
      .then(buf => {
        const wb = XLSX.read(buf, { type: "array" });
        const sheetName = wb.SheetNames[0];
        office.innerHTML = XLSX.utils.sheet_to_html(wb.Sheets[sheetName]);
        _previewHideLoading();
      })
      .catch((e) => {
        console.error(e);
        office.innerHTML = "Não foi possível renderizar a planilha.";
        _previewHideLoading();
      });
    return false;
  }

  // PPT fallback
  if (mediatype === "ppt") {
    window.open(url, "_blank");
    return false;
  }

  window.open(url, "_blank");
  return false;
}

var confirmationModal = document.getElementById('confirmationModal');
confirmationModal.addEventListener('show.bs.modal', function (event) {
  // Button that triggered the modal
  var button = event.relatedTarget;
  // Extract info from data-bs-* attributes
  var pergunta = button.getAttribute('data-bs-pergunta');
  var modalBody = confirmationModal.querySelector('.modal-body');
  modalBody.textContent = pergunta;
  var modalSim = document.getElementById('modalSimBtn');
  modalSim.setAttribute("href", button.getAttribute('data-bs-href'));
})

var newNameModal = document.getElementById('newNameModal');
newNameModal.addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget;
  var modalTrocaBtn = document.getElementById('modalTrocaBtn');
  modalTrocaBtn.setAttribute("data-bs-href", button.getAttribute('data-bs-href'));;
})

/* ---- troca de nome: OK/NOK ---- */
function trocanome() {
  const btn = document.getElementById("modalTrocaBtn");
  const input = document.getElementById("modalInputField");

  const msg = document.getElementById("trocaNomeMsg");
  const btnText = document.getElementById("trocaNomeBtnText");
  const btnSpin = document.getElementById("trocaNomeBtnSpin");

  if (!btn || !input) {
    console.error("modalTrocaBtn ou modalInputField não encontrado");
    return false;
  }

  const href = btn.getAttribute("data-bs-href") || "";
  const novonome = (input.value || "").trim();

  if (msg) { msg.classList.add("d-none"); msg.textContent = ""; }

  if (!novonome) {
    if (msg) { msg.textContent = "Informe o novo nome."; msg.classList.remove("d-none"); }
    input.focus();
    return false;
  }

  const url = href + encodeURIComponent(novonome);

  // loading UI
  btn.disabled = true;
  btn.setAttribute("aria-disabled", "true");
  if (btnText) btnText.textContent = "Trocando...";
  if (btnSpin) btnSpin.classList.remove("d-none");

  const xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);

  xhr.onreadystatechange = function () {
    if (xhr.readyState !== 4) return;

    btn.disabled = false;
    btn.removeAttribute("aria-disabled");
    if (btnText) btnText.textContent = "Confirmar";
    if (btnSpin) btnSpin.classList.add("d-none");

    if (xhr.status !== 200) {
      if (msg) { msg.textContent = "Erro de comunicação com o servidor."; msg.classList.remove("d-none"); }
      console.error(xhr.status, xhr.responseText);
      return;
    }

    const resp = (xhr.responseText || "").trim();

    if (resp === "OK") {
      // fecha modal bootstrap se existir
      const modalEl = document.getElementById("trocaNomeModal");
      if (modalEl && window.bootstrap) {
        bootstrap.Modal.getInstance(modalEl)?.hide();
      }
      location.reload();
      return;
    }

    if (msg) {
      msg.textContent = (resp === "NOK")
        ? "Não foi possível trocar o nome. Verifique se o nome já existe, é inválido ou está em uso."
        : ("Resposta inesperada do servidor: " + resp);
      msg.classList.remove("d-none");
    }
    input.focus();
  };

  xhr.send();
  return false;
}
</script>
</body>
<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<!-- DOCX -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.15/dist/docx-preview.min.js"></script>
<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- PPTXjs (meshesha) CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/css/pptxjs.css">

<!-- (opcional) gráficos -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/css/nv.d3.min.css">

<!-- Dependências do PPTXjs (meshesha) -->
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/filereader.js"></script>
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/dingbat.js"></script>

<!-- (opcional) gráficos -->
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/nv.d3.min.js"></script>

<!-- Plugin principal + slide mode -->
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/pptxjs.js"></script>
<script src="https://cdn.jsdelivr.net/gh/meshesha/PPTXjs@master/js/divs2slides.js"></script>

<script>
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.getAttribute("obj"));
  }

  function drop(ev) {
      ev.preventDefault();
      var data = ev.dataTransfer.getData("text");
      console.log('data:', data);
      var dest = ev.target.getAttribute("obj")
      console.log('dest:', dest);
      const Http = new XMLHttpRequest();
      const url='/move?from_=' + data + '&to_=' + dest;
      Http.open("GET", url, false);
      Http.onload = function() {
          if (Http.status >= 200 && Http.status < 300) {
              console.log('Response:', Http.responseText);
              if (Http.responseText == "" || Http.responseText == "OK") {
                window.location.reload();
              }
              else if(Http.responseText == "NOK") {
                alert("Movimentação falhou !");
              }
              else {
                window.location.href = Http.responseText;
              }
          } else {
              // Handle error
              console.error('Error:', Http.statusText);
              //window.location.reload();
          }
      };
        // Handle network errors
      Http.onerror = function() {
          console.error('Request failed');
      };
      Http.send();
  }
</script>

<script>
  $("#show-form-adddir").click(function(){
    const btn = document.getElementById('show-form-adddir');
    const form = document.getElementById('form-adddir');
    if (btn) btn.style.display="none";
    if (form) form.style.display="flex";
  });

  $("#show-form-upload").click(function(e){
    // NOVO: se existe upload-panel (modo XHR), NÃO esconda o botão Upload
    const panel = document.getElementById('upload-panel');
    if (panel) {
      e.preventDefault();
      // deixa o script do home.html controlar abrir/fechar,
      // mas se quiser garantir aqui também:
      panel.classList.remove("d-none");
      return;
    }

    // LEGADO: se existe form-upload, mantém o comportamento antigo
    const btn = document.getElementById('show-form-upload');
    const form = document.getElementById('form-upload');
    if (btn) btn.style.display="none";
    if (form) form.style.display="flex";
  });

  $("#show-form-search").click(function(){
    const btn = document.getElementById('show-form-search');
    const form = document.getElementById('form-search');
    if (btn) btn.style.display="none";
    if (form) form.style.display="flex";
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const confirmationModal = document.getElementById("confirmationModal");
  if (!confirmationModal) return;

  confirmationModal.addEventListener("show.bs.modal", function (event) {
    const trigger = event.relatedTarget; // botão que abriu o modal
    if (!trigger) return;

    const href = trigger.getAttribute("data-bs-href");
    const pergunta = trigger.getAttribute("data-bs-pergunta");

    const body = confirmationModal.querySelector(".modal-body");
    if (body) body.textContent = pergunta || "Confirma ?";

    const simBtn = document.getElementById("modalSimBtn");
    if (simBtn) {
      // opção 1: navegar via href
      simBtn.setAttribute("href", href || "#");

      // opção 2 (mais garantida): forçar navegação no click
      simBtn.onclick = function (e) {
        e.preventDefault();
        if (href) window.location.href = href;
      };
    }
  });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
      const showfilemodal = document.getElementById('showfileModal');
      // Close the modal when clicking outside of the modal content
      window.onclick = function(event) {
          if (event.target === showfilemodal) {
              closeModal();  // Hide the modal
          }
      };
  });

  let _JSZipV3 = window.JSZip; // guarda o v3 (docx-preview)

  function loadScriptOnce(src) {
    return new Promise((resolve, reject) => {
      if ([...document.scripts].some(s => s.src === src)) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function withJSZipV2(fn) {
    // carrega JSZip v2 se ainda não tiver
    await loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/jszip/2.6.1/jszip.min.js");
    const zip2 = window.JSZip;         // agora é v2
    const prev = window.JSZip;         // (mesmo)
    // restaura v3 depois do render
    try {
      window.JSZip = zip2;
      await fn();
    } finally {
      window.JSZip = _JSZipV3;
    }
  }

  function handleDoubleClick(event, mediatype) {
    const obj =
      event.target.getAttribute("obj") ||
      event.target.closest("[obj]")?.getAttribute("obj");

    if (!obj) return;

    const url = "/browse/" + obj;
    const ext = (obj.split(".").pop() || "").toLowerCase();

    const modal = document.getElementById("showfileModal");
    const label = document.getElementById("pdfModalLabel");

    const loading = document.getElementById("previewLoading");

    const img = document.getElementById("showfileImage");
    const pdf = document.getElementById("showfilePdf");
    const vid = document.getElementById("showfileVideo");
    const aud = document.getElementById("showfileAudio");
    const txt = document.getElementById("showfileText");
    const office = document.getElementById("showfileOffice");

    function showLoading() {
      if (loading) loading.classList.remove("d-none");
    }
    function hideLoading() {
      if (loading) loading.classList.add("d-none");
    }

    function clearMediaHandlers() {
      if (img) { img.onload = null; img.onerror = null; }
      if (pdf) { pdf.onload = null; pdf.onerror = null; }
      if (vid) {
        vid.onloadeddata = null; vid.oncanplay = null; vid.oncanplaythrough = null;
        vid.onloadedmetadata = null; vid.onerror = null; vid.onwaiting = null; vid.onplaying = null;
      }
      if (aud) {
        aud.onloadeddata = null; aud.oncanplay = null; aud.oncanplaythrough = null;
        aud.onloadedmetadata = null; aud.onerror = null; aud.onwaiting = null; aud.onplaying = null;
      }
    }

    function hideAll() {
      clearMediaHandlers();
      [img, pdf, vid, aud, txt, office].forEach(el => el?.classList.add("d-none"));
      hideLoading();

      if (img) img.src = "";
      if (pdf) pdf.src = "";

      if (vid) { vid.pause?.(); vid.removeAttribute("src"); vid.load?.(); }
      if (aud) { aud.pause?.(); aud.removeAttribute("src"); aud.load?.(); }

      if (txt) txt.textContent = "";
      if (office) office.innerHTML = "";
    }

    hideAll();

    function openModal(title) {
      if (label) label.textContent = title;
      modal.style.display = "block";
    }

    // IMAGEM
    if (mediatype === "image") {
      openModal("Imagem");
      showLoading();
      img.onload = () => hideLoading();
      img.onerror = () => hideLoading();
      img.src = url;
      img.classList.remove("d-none");
      return;
    }

    // PDF
    if (mediatype === "pdf") {
      openModal("PDF");
      showLoading();
      pdf.onload = () => hideLoading();
      pdf.onerror = () => hideLoading();
      pdf.src = url;
      pdf.classList.remove("d-none");
      return;
    }

    // VÍDEO
    if (mediatype === "video") {
      openModal("Vídeo");
      showLoading();

      const done = () => hideLoading();
      const fail = () => hideLoading();

      // eventos mais confiáveis
      vid.onloadedmetadata = done;
      vid.oncanplaythrough = done;
      vid.onerror = fail;

      // buffering
      vid.onwaiting = () => showLoading();
      vid.onplaying = () => hideLoading();

      vid.src = url;
      vid.classList.remove("d-none");
      vid.load(); // <-- importante
      return;
    }

    // ÁUDIO
    if (mediatype === "audio") {
      openModal("Áudio");
      showLoading();

      const done = () => hideLoading();
      const fail = () => hideLoading();

      aud.onloadedmetadata = done;
      aud.oncanplaythrough = done;
      aud.onerror = fail;

      aud.onwaiting = () => showLoading();
      aud.onplaying = () => hideLoading();

      aud.src = url;
      aud.classList.remove("d-none");
      aud.load(); // <-- importante
      return;
    }

    // TEXTO
    if (mediatype === "text") {
      openModal("Texto");
      showLoading();
      fetch(url)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(content => {
          txt.textContent = content;
          txt.classList.remove("d-none");
          hideLoading();
        })
        .catch(() => {
          txt.textContent = "Erro ao carregar arquivo de texto.";
          txt.classList.remove("d-none");
          hideLoading();
        });
      return;
    }

    // DOCX
    if (mediatype === "doc") {
      openModal("Documento");
      showLoading();
      office.classList.remove("d-none");
      fetch(url)
        .then(r => r.arrayBuffer())
        .then(buf => window.docx?.renderAsync(buf, office))
        .then(() => hideLoading())
        .catch(() => {
          office.innerHTML = "Não foi possível renderizar o DOCX.";
          hideLoading();
        });
      return;
    }

    // XLSX / XLS
    if (mediatype === "excel") {
      openModal("Planilha");
      showLoading();
      office.classList.remove("d-none");
      fetch(url)
        .then(r => r.arrayBuffer())
        .then(buf => {
          const wb = XLSX.read(buf, { type: "array" });
          const sheetName = wb.SheetNames[0];
          const html = XLSX.utils.sheet_to_html(wb.Sheets[sheetName]);
          office.innerHTML = html;
          hideLoading();
        })
        .catch(() => {
          office.innerHTML = "Não foi possível renderizar a planilha.";
          hideLoading();
        });
      return;
    }

    // PPT/PPTX -> PDF (backend)
    if (mediatype === "ppt-fututo") {
      openModal("Apresentação");
      _previewShowLoading();

      // usa iframe de PDF do modal
      if (!pdf) {
        _previewHideLoading();
        window.open(url, "_blank");
        return false;
      }

      pdf.classList.remove("d-none");

      // chama endpoint novo que converte e devolve PDF inline
      const pdfUrl = "/pptpdf/" + obj;

      pdf.onload = () => _previewHideLoading();
      pdf.onerror = () => _previewHideLoading();

      pdf.src = pdfUrl;
      return false;
    }

    // fallback
    window.open(url, "_blank");
  }

</script>
</html>